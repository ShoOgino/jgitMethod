	private File toTemp(final MessageDigest md, final int type, long len,
			final InputStream is) throws IOException, FileNotFoundException,
			Error {
		boolean delete = true;
		File tmp = newTempFile();
		try {
			DigestOutputStream dOut = new DigestOutputStream(
					compress(new FileOutputStream(tmp)), md);
			try {
				writeHeader(dOut, type, len);

				final byte[] buf = buffer();
				while (len > 0) {
					int n = is.read(buf, 0, (int) Math.min(len, buf.length));
					if (n <= 0)
						throw shortInput(len);
					dOut.write(buf, 0, n);
					len -= n;
				}
			} finally {
				dOut.close();
			}

			delete = false;
			return tmp;
		} finally {
			if (delete)
				tmp.delete();
		}
	}

