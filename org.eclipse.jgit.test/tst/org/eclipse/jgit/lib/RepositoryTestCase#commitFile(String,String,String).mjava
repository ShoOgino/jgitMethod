	/**
	 * Commit a file with the specified contents on the specified branch,
	 * creating the branch if it didn't exist before.
	 * <p>
	 * It switches back to the original branch after the commit if there was
	 * one.
	 *
	 * @param filename
	 * @param contents
	 * @param branch
	 * @return the created commit
	 */
	protected RevCommit commitFile(String filename, String contents, String branch) {
		try {
			Git git = new Git(db);
			String originalBranch = git.getRepository().getFullBranch();
			if (git.getRepository().getRef(branch) == null)
				git.branchCreate().setName(branch).call();
			git.checkout().setName(branch).call();
			writeTrashFile(filename, contents);
			git.add().addFilepattern(filename).call();
			RevCommit commit = git.commit()
					.setMessage(branch + ": " + filename).call();
			if (originalBranch != null)
				git.checkout().setName(originalBranch).call();
			return commit;
		} catch (IOException e) {
			throw new RuntimeException(e);
		} catch (GitAPIException e) {
			throw new RuntimeException(e);
		}
	}

