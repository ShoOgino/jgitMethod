	@SuppressWarnings("unchecked")
	@Test
	public void testInsertRead() throws IOException {
		DhtInserterOptions insopt = new DhtInserterOptions();
		insopt.setChunkSize(128);
		insopt.setCompression(Deflater.NO_COMPRESSION);

		Repository repo = new DhtRepositoryBuilder() //
				.setDatabase(db) //
				.setInserterOptions(insopt) //
				.setRepositoryName("test.git") //
				.setMustExist(false) //
				.build();
		repo.create(true);

		byte[] data = new byte[insopt.getChunkSize() * 3];
		Arrays.fill(data, (byte) 0x42);

		ObjectInserter ins = repo.newObjectInserter();
		ObjectId id = ins.insert(Constants.OBJ_BLOB, data);
		ins.flush();
		ins.release();

		ObjectReader reader = repo.newObjectReader();
		ObjectLoader ldr = reader.open(id);
		assertEquals(Constants.OBJ_BLOB, ldr.getType());
		assertEquals(data.length, ldr.getSize());
		assertTrue(ldr.isLarge());

		byte[] dst = new byte[data.length];
		ObjectStream in = ldr.openStream();
		IO.readFully(in, dst, 0, dst.length);
		assertTrue(Arrays.equals(data, dst));
		in.close();

		// Reading should still work, even though initial chunk is gone.
		dst = new byte[data.length];
		in = ldr.openStream();
		IO.readFully(in, dst, 0, dst.length);
		assertTrue(Arrays.equals(data, dst));
		in.close();

		reader.release();
	}

